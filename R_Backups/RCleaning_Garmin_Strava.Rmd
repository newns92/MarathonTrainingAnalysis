---
title: "Marathon Training Plan Data Cleaning"
author: "Steve Newns"
date: "January 18, 2017"
output:
  html_document: default
  word_document: default
---

# *Initial Data Inspection*

## Strava Data File

First, I install the necessary packages I need to clean up the data.

```{r install packages}
#install.packages("stringr")  - for manipulating string values
#install.packages("tidyr")    - data cleansing
#install.packages("plyr")     - for renaming columns
#install.packages("lubridate")  - working with dates
```

Next, I load in the CSV file created by and downloaded from **VeloViewer.com** containing my Strava data and check out the dataset.

```{r strava data inspection, }
strava <- read.csv("strava.csv")
dim(strava)
head(strava)
```

Okay, so there's 201 activities in here, as well as a lot of columns (85 of them), with a majority of these columns probably not being useful for my purposes right now. 

Now I want to explore the Garmin data as well before moving on to removing those unneccessary columns.

## Garmin Data Files

First, I load in the first of the CSV files containing the Garmin data created by and downloaded from **Garmin Connect** and check out the dataset.

```{r garmin data inspection}
garmin1 <- read.csv("garmin1.csv")
dim(garmin1)
head(garmin1)
```

So there's 21 runs in here, with 16 variables. Let's look at another Garmin data file.

```{r garmin data inspection2}
garmin6 <- read.csv("garmin6.csv")
dim(garmin1)
head(garmin6)
```

Okay, good, same amount of runs and variables. Now it's time to load the rest of the Garmin data files in and combine them all into a single data frame to hold all of the Garmin data.

```{r load rest of garmin data}
garmin2 <- read.csv("garmin2.csv")
garmin3 <- read.csv("garmin3.csv")
garmin4 <- read.csv("garmin4.csv")
garmin5 <- read.csv("garmin5.csv")

#Combine data files into 1 data frame
garminFull <- Reduce(function(...) merge(..., all=TRUE), list(garmin1, garmin2, garmin3, garmin4, 
                                                              garmin5, garmin6))
dim(garminFull)
summary(garminFull)
head(garminFull)
```

It looks like there's 2 random NULL records in the 122 activities, located at the start of the data frame's records. These are throwing things off, and maybe they're due the way Garmin delivers the data when I download the activities from the Garmin Connect site. Or maybe *I* did something wrong. I don't know really.

But we still have to remove these top 2 blank rows.

```{r clean garmin data}
garminFull <- garminFull[-c(1,2),]
head(garminFull)
```

#Further Cleaning
##Remove Extra Columns

So now it's time to remove the Strava columns that would be unneccessary for what I'm doing here, based on the variables I pulled from Garmin.

```{r remove strava columns}
keepCols <- NA
keepCols <- c("Activity.Id", "When", "Type", "Gear", "Name", "Dist.mi", "Elv.ft", "Elapsed.Time", "Moving.Time",
              "Speed.mph", "Pace..mi", "Max.Pace..mi", "Cad", "Heart", "Max.Heart", "Elev.Dist.ft.mi",
              "Elev.Time.ft.h", "Cal", "Segs", "PRs", "Kudos")
newStrava <- strava[keepCols]
str(newStrava)
```

Now I want to split the DateTime field **When** into a specific **Date** and **StartTime** fields.

```{r split strava dates and check dupes1}
library(stringr)
newStrava$Date <- str_split_fixed(newStrava$When, " ", 2)[,1] #get 1st part of split When field for Date
newStrava$StartTime <- str_split_fixed(newStrava$When, " ", 2)[,2] #get 2nd part of split When field for StarTime

str(newStrava)
```

Okay, good, I've got 2 new character fields at the end there. Now onto the Garmin data cleaning. The date field, **Start** in Garmin is a bit different than in Strava, so some work needs to be done to get it into the same format, by first creating new fields from **Start**.

``` {r garmin data cleaning pt. 1}
library(tidyr)

#Specify the new column names:
vars <- c("Date", "StartTime")
vars2 <- c("DOW", "Date")

#Separate columns according to regex and/or delimiteres and proceed to drop remaining extra columns:
garminFull <- separate(garminFull, Start, into = vars, sep = "(?<=6 )", extra = "merge", remove = TRUE)
garminFull <- separate(garminFull, Date, into = vars2, sep = ", ", extra = "merge", remove = TRUE)

#Create MonthNumber field based on what is in Date field
garminFull$monthNum <- ifelse(grepl("Jan",garminFull$Date),1,
                            ifelse(grepl("Feb",garminFull$Date),2,
                            ifelse(grepl("Mar",garminFull$Date),3,
                            ifelse(grepl("Apr",garminFull$Date),4,
                            ifelse(grepl("May",garminFull$Date),5,
                            ifelse(grepl("Jun",garminFull$Date),6,
                            ifelse(grepl("Jul",garminFull$Date),7,
                            ifelse(grepl("Aug",garminFull$Date),8,
                            ifelse(grepl("Sep",garminFull$Date),9,
                            ifelse(grepl("Oct",garminFull$Date),10,
                            ifelse(grepl("Nov",garminFull$Date),11,
                            ifelse(grepl("Dec",garminFull$Date),12,NA))))))))))))
head(garminFull,2)
```

Now I've got **Date, Start Time, Day of Week,** and **Month Number** columns, and I can seperate the **Date** column in **Day, Month,** and **Year**.

```{r create dy, mth, yr fields}
vars3 <- c("Month", "Date")
vars4 <- c("Day", "Year")
garminFull <- separate(garminFull, Date, into = vars3, sep = " ", extra = "merge", remove = TRUE)
garminFull <- separate(garminFull, Date, into = vars4, sep = ", ", extra = "merge", remove = TRUE)
head(garminFull,2)
```

Looks like there's extra whitespace to the right in the **Year** field, so let's remove it and then create a Date field from the 3 components: *Day, Month, and Year.*

```{r remove whitespace and create date}
garminFull$Year <- trimws(garminFull$Year)

#Create Date field from 3 components: Day, Month, Year
garminFull$Date <- format(as.Date(with(garminFull, paste(Year, monthNum, Day,sep="-")), 
                                  "%Y-%m-%d"), "%m/%d/%Y")
str(garminFull$Date)
```

Okay, so we've got a **Date** field, although it's a character data type. But I'll fix that later. For now, I'll remove my unneccesary Garmin columns.

```{r remove garmin cols}
keepColsGarmin  <- NA
keepColsGarmin <- c("DOW", "Month", "StartTime", "Time", "Distance", 
                    "Elevation.Gain", "Avg.Speed.Avg.Pace.", "Avg.HR", 
                    "Max.HR", "Calories", "Date", "monthNum")
newGarmin <- garminFull[keepColsGarmin]
head(newGarmin,2)
```

Now to change my format for my **Date** fields in both datasets, just as my personal preference.

```{r format date}
newGarmin$Date <- as.Date(newGarmin$Date,"%m/%d/%Y")
newStrava$Date <- as.Date(newStrava$Date,"%m/%d/%Y")

#Check data type
str(newGarmin$Date)
str(newStrava$Date)
```

Now that I've got these fields in the right format, I need to sort them so that when I combine the data sets, fields coming from both data sets are showing data for the *same* activity.

```{r sort dates}
#Sort data frames from earliest to last date
newGarmin <- newGarmin[order(newGarmin$Date, decreasing = FALSE),] 
newStrava <- newStrava[order(newStrava$Date, decreasing = FALSE),]
head(newGarmin$Date)
head(newStrava$Date)
```

So, my runs from Strava seem to be starting back in January, which was *way* before my marathon training plan kicked in, and was mainly some basic runs in preperation for the Broad Street Run. The marathon training plan started right after the Tour De Shore bike ride I did on July 17, so I need to remove all runs prior to that 1st training plan run on July 19 (two days later since I needed one to recover from that ride!).

```{r remove excess strava runs}
newStrava <- newStrava[!newStrava$Date < "2016-07-18",]
```

I need to double-check that the amount of rows in each data frame match up so that they can be combined correctly.

```{r check nrow pt 1}
nrow(newGarmin)
nrow(newStrava)
```

So there's still 3 extra Garmin runs, and I need to find out what they are. I'll check a table of the run distances to see if anything sticks out.

```{r check garmin runs}
table(newGarmin$Distance)  
```

So there's 2 runs that are less than one-fifth of a mile? That is *definitely* not right. The run with **1.42** miles seems a bit off as well, but maybe I got lazy in my determination to end on a whole number of miles.

```{r check garmin runs2}
newGarmin[newGarmin$Distance=="0.12",]  
newGarmin[newGarmin$Distance=="0.16",]  
newGarmin[newGarmin$Distance=="1.42",]  
```

So those 1st two runs look to actually be spin sessions, based on the long times but incredibly short distances (thanks to my wristwatch moving up and down while I was tracking heart rate on the bike), but the 1.42 mile run just seems to be a light run that I didn't run to an even 0.50 interval of mile (*very* unlike me). So let's remove those 1st two runs, but keep the 1.42-miler.

```{r remove spin}
newGarmin <- newGarmin[!newGarmin$Date == "2016-08-27",]
newGarmin <- newGarmin[!newGarmin$Date == "2016-09-01",]
```

But there's still 1 more extra run. Let's check the dates for any duplicates.

```{r check garmin runs date2}
table(newGarmin$Date) > 1
```

There was probably an easier way to do this, but I see that there's the 2 runs on August 12, and also 2 on October 23.

```{r check august garmin runs}
which(newStrava$Date == '2016-08-12') 
```

Let's check those records.

```{r check aug dates}
newStrava[22:23,]
```

Looks like I just ran twice that day. I know I was down the shore, maybe I was just bored? I'll remove that run and move on to check the October 23 runs.

```{r check october garmin runs}
#check october garmin runs
newGarmin <- newGarmin[!newGarmin$Distance=="1.42",]
newStrava <- newStrava[!newStrava$Activity.Id=="677460614",]

newGarmin[newGarmin$Date == "2016-10-23",]
```

While I'd love to run a 4:18 min/mile pace and finish 15 miles in just over an hour, that looks like another bike ride, but outdoors , since it has a value for elevation, unlike our spin rides above. So let's remove that one and then check the row counts again.

```{r remove last bike ride}
newGarmin <- newGarmin[!(newGarmin$Date == "2016-10-23" & newGarmin$Elevation.Gain == 657),]

nrow(newGarmin)
nrow(newStrava)
```

Great, now I have the same amount of runs in each data set. Let's check the first couple of records just to make sure they line up.

```{r check date match up}
head(newGarmin)
head(newStrava)
```

Awesome, they line up. Let's rename the date and time columns in Garmin so we can distinguish them from the respective Strava fields and then remove the unneccessary **When** column

```{r rename garmin cols}
library(plyr)
newGarmin <- rename(newGarmin, c("Date"="date_garmin"))
newGarmin <- rename(newGarmin, c("StartTime"="StartTime_AM_PM"))
newStrava$When <- NULL #removes column
```

Now that we have cleaned up both data sets, and can combine them into one, full, complete data set, and double-check the dates again.

```{r combine data sets}
newFullData <- cbind(newGarmin,newStrava)
#inspect
head(newFullData,3)
#check dates
head(newFullData[,c("Date","date_garmin")])
tail(newFullData[,c("Date","date_garmin")])
```

Okay, now I can move on to keep the columns that I need for what I want to do with this data, and then order them in a more intuitive manner.

```{r keep full dataset cols}
newFullData <- rename(newFullData, c("Activity.Id"="ID"))

keepColsFull  <- NA
keepColsFull <- c("ID", "Gear", "Name", "Speed.mph", "Cad", "Date",
                  "StartTime", "DOW", "Month",  "Time", "Distance",
                  "Elevation.Gain", "Avg.Speed.Avg.Pace.", "Avg.HR",
                  "Max.HR", "Calories", "monthNum")
newFullData <- newFullData[keepColsFull]

#rearrange columns
newFullData <- newFullData[, c("ID", "Name", "Gear", "Date",
                               "Month", "monthNum", "DOW", "StartTime",
                               "Distance", "Time", "Avg.Speed.Avg.Pace.", 
                               "Speed.mph", "Cad",  "Elevation.Gain", 
                               "Avg.HR", "Max.HR", "Calories")]
```

Now I want to check the names of the runs I input into Strava when uploading them from my watch to make sure they're consistent, and I then can categorize them for an accurate analysis.

```{r check run names}
table(newFullData$Name) 
```

So there seems to be some inconsistencies (and a typo) for my *Middle Long Runs*, so now I need to correct them. I'll put them in a single category as **ML Run**.

```{r fix ml runs}
newFullData$Name[newFullData$Name == 'MIddle Long Run'] <- 'ML Run'
newFullData$Name[newFullData$Name == 'Middle Long Run'] <- 'ML Run'
```

There also seems to be 2 runs with the name "Morning Run", which was not the name of 1 of my types of runs in this plan, so let's investigate these runs.

```{r check morning runs}
newFullData[newFullData$Name == 'Morning Run',] 
```

So, based off of distance, shoe type, and pace, I can safely assume that the run on 7/23 was a Recovery Run, and the run on 7/27 was a ML Run, so I can edit them as so.

```{r remove morning runs}
newFullData$Name[newFullData$ID == 650512799] <- 'Recovery Run'
newFullData$Name[newFullData$ID == 655096239] <- 'ML Run'
```

Now, based off of the run names, I want to create 4 categories (inspired by the category choices on Strava) for **workouts, Long Runs, Recovery Runs,** and just plain ol' **Runs**, which consist of **General Aerobic (GA)** and **Middle Long (ML) runs**

```{r new run categories}
newFullData$RunType <- ifelse(grepl('LT',newFullData$Name),'Workout',
                        ifelse(grepl('Tempo',newFullData$Name),'Workout',
                          ifelse(grepl('Tune',newFullData$Name),'Workout',
                            ifelse(grepl('VO2',newFullData$Name),'Workout',
                              #ifelse(grepl('MP',newFullData$Name),'Workout',
                                ifelse(grepl('Long',newFullData$Name),'Long Run',
                                  ifelse(grepl('Recovery',newFullData$Name),'Recovery Run',
                                    ifelse(grepl('Marathon',newFullData$Name),'Race','Run')))))))#)
table(newFullData$RunType)
```

Looks like I've got a lot of "plain" runs and a lot of recovery runs. Just goes to show that you don't need to kill yourself out there every time you run to race a marathon! 

Now time to convert my heart rate variables **Avg.HR** and **Max.HR**, as well as my **Calories** and **Elevation.Gain** variables so that they're numerical and I can do math and statistics operations on them.

```{r fix HR and cals}
newFullData$Avg.HR <- as.numeric(as.character(newFullData$Avg.HR, stringsAsFactors = FALSE))
newFullData$Max.HR <- as.numeric(as.character(newFullData$Max.HR, stringsAsFactors = FALSE))
newFullData$Calories <- as.numeric(gsub(",","",newFullData$Calories))
newFullData$Elevation.Gain <- as.numeric(as.character(newFullData$Elevation.Gain, stringsAsFactors = FALSE))
```

Now time to fix my Cadence figures, since it seems like they are half of what they should be.

```{r fix cadence}
newFullData$Cad <- newFullData$Cad*2
str(newFullData)
```

Alright, cool. I also see my time fields, **Avg.Speed.Avg.Pace** and **Time** are not in the correct format. I need to convert them to **POSIXct** in order to do some work with them. I need to convert my pace to the correct format via **as.POSIXct()**, since it's already pretty much in the correct numerical format.

```{r fix avg pace}
library(lubridate)

#fix Average Pace
newFullData$Avg.Speed.Avg.Pace. <- as.POSIXct(newFullData$Avg.Speed.Avg.Pace., format = '%M:%S')
plot(newFullData$Date,newFullData$Avg.Speed.Avg.Pace.) #test plot
newFullData$Avg.Pace <- newFullData$Avg.Speed.Avg.Pace.
newFullData$Avg.Speed.Avg.Pace. <- NULL
```

Now, for **Time**, some values are missing the hour, some have the minutes in the hour place, etc. so I can fix this with a FOR loop in order to find the "incorrect" values and fix each one respectively.

```{r fix total time}
newFullData$Time <- as.character(newFullData$Time)

for (i in 1:nrow(newFullData)) {
  if (nchar(newFullData$Time[i]) == 4) {
    newFullData$Time[i] <- paste("0:0", newFullData$Time[i], sep="")
  } else if (nchar(newFullData$Time[i]) == 8) {
    newFullData$Time[i] <- paste("0:",substring(newFullData$Time[i],1,5), sep="")
  } else if (nchar(newFullData$Time[i]) == 5) {
    newFullData$Time[i] <- paste("0:",newFullData$Time[i], sep="")
  }  
}
newFullData$Time <- as.POSIXct(newFullData$Time, format = '%H:%M:%S')

#test plot
plot(newFullData$Date,newFullData$Time)
```

Great. Now the final thing to do is to make sure my **Month** variable is indeed ordered correctly with **factor()**.s

```{r order month}
newFullData$Month <- factor(newFullData$Month, ordered = TRUE, levels = c("Jul","Aug","Sep","Oct","Nov"))
class(newFullData$Month)
```

Now to save this dataset to a file to read into another script so I can do some analysis.

```{r write dataset to file}
write.csv(newFullData, file = "cleanedMarathonTrainingData.csv", row.names = TRUE)
```