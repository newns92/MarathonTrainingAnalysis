---
title: "R Cleaning RMarkdown"
author: "Steve Newns"
date: "January 13, 2017"
output:
  html_document: default
  word_document: default
---

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

##Data Inspection

First, I load in the CSV file containing the Strava data file created by and downloaded from **VeloViewer** and check the structure of the dataset.

```{r strava data inspection}
setwd("C:/Users/snewns/Dropbox/RunningAnalysis/Data")
strava <- read.csv("strava.csv")
str(strava)
head(strava)
```

Okay, so there's a lot of columns here, with a majority of them not being useful for my purposes right now. Now I want to explore the Garmin data as well before moving on the removing unneccessary columns

##GARMIN DATA FILES

Then, I load in the first CSV file containing the Garmin data file created by and downloaded from **Garmin Connect** and check the structure of the dataset.

```{r garmin data inspection}
setwd("C:/Users/snewns/Dropbox/RunningAnalysis/Data")
garmin1 <- read.csv("garmin1.csv")
str(garmin1)
head(garmin1)
```

Let's look at another Garmin data file.
```{r garmin data inspection2}
setwd("C:/Users/snewns/Dropbox/RunningAnalysis/Data")
garmin6 <- read.csv("garmin6.csv")
head(garmin6)
```

Okay, good, now it's time to load in the rest of the Garmin data files and combine them into a single data frame to contain all of the Garmin data

```{r load rest of garmin data}
setwd("C:/Users/snewns/Dropbox/RunningAnalysis/Data")
garmin2 <- read.csv("garmin2.csv")
garmin3 <- read.csv("garmin3.csv")
garmin4 <- read.csv("garmin4.csv")
garmin5 <- read.csv("garmin5.csv")

#Combine data files into 1 data frame
garminFull <- Reduce(function(...) merge(..., all=TRUE), list(garmin1, garmin2, garmin3, garmin4, 
                                                              garmin5, garmin6))
str(garminFull)
summary(garminFull)
head(garminFull)
```

It looks like there's 2 random NULL records at the top of the data frame records throwing things off that maybe from the way Garmin delivers the data when I downloaded the activities from the Garmin Connect site. Or maybe I did something wrong. I dunno really.

So we have to remove these top 2 blank rows

```{r clean garmin data}
garminFull <- garminFull[-c(1,2),]
head(garminFull)

str(garminFull)
summary(garminFull)
```

So now it's time to remove the Strava columns that would be unneccessary for what I'm doing here, based on what I could pull from Garmin

```{r remove strava columns}
keepCols <- NA
keepCols <- c("Activity.Id", "When", "Type", "Gear", "Name", "Dist.mi", "Elv.ft", "Elapsed.Time", "Moving.Time",
              "Speed.mph", "Pace..mi", "Max.Pace..mi", "Cad", "Heart", "Max.Heart", "Elev.Dist.ft.mi",
              "Elev.Time.ft.h", "Cal", "Segs", "PRs", "Kudos")
newStrava <- strava[keepCols]
str(newStrava)
head(newStrava)
tail(newStrava)
```

There seems to be multiple runs on August 12? I was down the shore that weekend. Maybe it was a bike ride?

```{r split strava dates and check dupes}
#install.packages("stringr")
library(stringr)
newStrava$Date <- str_split_fixed(newStrava$When, " ", 2)[,1]
newStrava$StartTime <- str_split_fixed(newStrava$When, " ", 2)[,2]

#Find the records from August 12
which(newStrava$Date == '8/12/2016')
newStrava[95:96,]
```

It looks like I just ran twice that day down the shore, which I vaguely remember, but cannot fathom why I did so. Anyway, now to the Garmin data cleaning
``` {r garmin data cleaning pt. 1}
head(garminFull)
#Create Date, Time, and Month Number fields
#install.packages("tidyr")
library(tidyr)
# specify the new column names:
vars <- c("Date", "StartTime")
vars2 <- c("DOW", "Date")
# then separate the "Details" column according to regex and drop extra columns:
garminFull <- separate(garminFull, Start, into = vars, sep = "(?<=6 )", extra = "merge", remove = TRUE)
garminFull <- separate(garminFull, Date, into = vars2, sep = ", ", extra = "merge", remove = TRUE)

#garminFull[order(garminFull$Date),]

garminFull$monthNum <- ifelse(grepl("Jan",garminFull$Date),1,
                            ifelse(grepl("Feb",garminFull$Date),2,
                            ifelse(grepl("Mar",garminFull$Date),3,
                            ifelse(grepl("Apr",garminFull$Date),4,
                            ifelse(grepl("May",garminFull$Date),5,
                            ifelse(grepl("Jun",garminFull$Date),6,
                            ifelse(grepl("Jul",garminFull$Date),7,
                            ifelse(grepl("Aug",garminFull$Date),8,
                            ifelse(grepl("Sep",garminFull$Date),9,
                            ifelse(grepl("Oct",garminFull$Date),10,
                            ifelse(grepl("Nov",garminFull$Date),11,
                            ifelse(grepl("Dec",garminFull$Date),12,NA))))))))))))
head(garminFull)
```

Now I've got Date, Start Time,  Day of Week, and Month Number columns, and I can seperate the Date column in Day, Month, and Year.

```{r create dy, mth, yr fields}
vars3 <- c("Month", "Date")
garminFull <- separate(garminFull, Date, into = vars3, sep = " ", extra = "merge", remove = TRUE)
#head(garminFull)
vars4 <- c("Day", "Year")
garminFull <- separate(garminFull, Date, into = vars4, sep = ", ", extra = "merge", remove = TRUE)
head(garminFull)

#Remove extra space in front of Year field
garminFull$Year <- trimws(garminFull$Year)

#Create Date field from its 3 components: Day, Month, Year
garminFull$Date <- format(as.Date(with(garminFull, paste(Year, monthNum, Day,sep="-")), "%Y-%m-%d"), "%m/%d/%Y")
str(garminFull$Date)
```

Now I can remove my unneccesary Garmin columns
```{r remove garmin cols}
#Remove
keepColsGarmin  <- NA
keepColsGarmin <- c("DOW", "Month", "StartTime", "Time", "Distance", "Elevation.Gain", "Avg.Speed.Avg.Pace.", "Avg.HR", 
                    "Max.HR", "Calories", "Date", "monthNum")
newGarmin <- garminFull[keepColsGarmin]
head(newGarmin)
```

I also want to change my format for my Date field, just as a personal preference

```{r format date}
newGarmin$Date <- as.Date(newGarmin$Date,"%m/%d/%Y")
newStrava$Date <- as.Date(newStrava$Date,"%m/%d/%Y")

#Check data type
str(newGarmin$Date)
str(newStrava$Date)

#Sort data frames from earliest to last date
newGarmin <- newGarmin[order(newGarmin$Date, decreasing = FALSE),] 
newStrava <- newStrava[order(newStrava$Date, decreasing = FALSE),]
head(newGarmin)
head(newStrava)
```

So my runs from Strava seem to be starting back in January which was *way* before my marathon training plan kicked in, and was mainly for the Broad Street Run. The marathon training plan started right after the Tour De Shore I did in July, so I need to remove all runs prior to that 1st training plan run on July 18.

```{r remove excess strava runs}
newStrava <- newStrava[!newStrava$Date < "2016-07-18",]
```

I need to double-check that the amount of rows in each data frame match so that they can be combined correctly
```{r check nrow pt 1}
nrow(newGarmin)
nrow(newStrava)
summary(newGarmin)
```

So there's still 3 extra Garmin runs from January 2016, which was not a part of my marathon training, so I need to remove them.

##check in excel (how in R?)
#write.csv(newStrava$Date, file = "fullStravaDates.csv", row.names = FALSE)
#write.csv(newGarmin$Date, file = "fullGarminDates.csv", row.names = FALSE)

#remove false runs
newGarmin <- newGarmin[!newGarmin$Date == "2016-08-27",]
newGarmin <- newGarmin[!newGarmin$Date == "2016-09-01",]
newGarmin[newGarmin$Date == "2016-10-23",]
#remove bike ride
newGarmin <- newGarmin[!(newGarmin$Date == "2016-10-23" & newGarmin$Elevation.Gain == 657),]

nrow(newGarmin)
nrow(newStrava) #match now

head(newGarmin)
head(newStrava)
#install.packages("plyr") #for rename cols
library(plyr)
newGarmin <- rename(newGarmin, c("Date"="date_garmin"))
newGarmin <- rename(newGarmin, c("StartTime"="StartTime_AM_PM"))
newStrava$When <- NULL #remove column

newFullData <- cbind(newGarmin,newStrava)
head(newFullData)
newFullData[,c("Date","date_garmin")]
#dates match

newFullData <- rename(newFullData, c("Activity.Id"="ID"))
names(newFullData)
keepColsFull  <- NA
keepColsFull <- c("ID", "Gear", "Name", "Speed.mph", "Cad", "Date", "StartTime", "DOW", "Month",  "Time", "Distance", 
                  "Elevation.Gain", "Avg.Speed.Avg.Pace.", "Avg.HR", "Max.HR", "Calories", "monthNum")
newFullData <- newFullData[keepColsFull]
#rearrange columns
newFullData <- newFullData[, c("ID", "Name", "Gear", "Date", "Month", "monthNum", "DOW", "StartTime",  "Distance", 
                               "Time", "Avg.Speed.Avg.Pace.", "Speed.mph", "Cad",  "Elevation.Gain", "Avg.HR", "Max.HR", 
                               "Calories")]
#newFullData$Type <- ?ifelse(?is.element('Middle Long' %in% newFullData$Name),"yes","no")
table(newFullData$Name) 

#write.csv(newFullData, file = "newFullData.csv", row.names = FALSE)
str(newFullData$ID)
#Fix typos in names
newFullData$Name[newFullData$Name == 'MIddle Long Run'] <- 'ML Run'
newFullData$Name[newFullData$Name == 'Middle Long Run'] <- 'ML Run'
newFullData[newFullData$Name == 'Morning Run',] #One recovery run and one ML run based off of distance and pace
newFullData$Name[newFullData$ID == 650512799] <- 'Recovery Run'
newFullData$Name[newFullData$ID == 655096239] <- 'ML Run'

#create new "run type" for run, recovery, long, workout etc.
newFullData$RunType <- ifelse(grepl('LT',newFullData$Name),'Workout',
                        ifelse(grepl('Tempo',newFullData$Name),'Workout',
                          ifelse(grepl('Tune',newFullData$Name),'Workout',
                            ifelse(grepl('V02',newFullData$Name),'Workout',
                              ifelse(grepl('Long',newFullData$Name),'Long Run',
                                ifelse(grepl('Recovery',newFullData$Name),'Recovery Run','Run'))))))
table(newFullData$RunType)
